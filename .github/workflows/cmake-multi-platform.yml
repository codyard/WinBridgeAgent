# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: CMake (Windows)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations. Consider changing this to true when your workflow is stable.
      fail-fast: false
      matrix:
        build_type: [Release]

    steps:
    # GitHub occasionally returns transient 5xx for git fetch on hosted runners.
    # Add a simple retry to reduce flaky CI failures.
    - name: Checkout (attempt 1)
      id: checkout1
      uses: actions/checkout@v4
      with:
        submodules: recursive
      continue-on-error: true

    - name: Wait before retry
      if: steps.checkout1.outcome == 'failure'
      run: |
        echo "Checkout failed, waiting 30 seconds before retry..."
        sleep 30
      shell: bash

    - name: Checkout (attempt 2)
      if: steps.checkout1.outcome == 'failure'
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set reusable strings
      # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

    - name: Debug refs
      shell: bash
      run: |
        echo "github.ref=${{ github.ref }}"
        echo "github.ref_name=${{ github.ref_name }}"
        echo "github.ref_type=${{ github.ref_type }}"

    - name: Configure CMake
      run: >
        cmake -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DCLAWDESK_ENABLE_OPENSSL=OFF
        -DCLAWDESK_BUILD_TESTS=OFF
        -S ${{ github.workspace }}

    - name: Build
      # Build your program with the given configuration. Note that --config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).
      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}

    - name: Package binaries
      id: package
      shell: pwsh
      run: |
        $buildDir = "${{ steps.strings.outputs.build-output-dir }}"
        $config = "${{ matrix.build_type }}"

        $distDir = Join-Path $buildDir "dist"
        New-Item -ItemType Directory -Force -Path $distDir | Out-Null

        $items = @(
          @{ src = (Join-Path $buildDir "$config\\WinBridgeAgent.exe"); dst = "WinBridgeAgent.exe" },
          @{ src = (Join-Path $buildDir "$config\\WinBridgeAgentDaemon.exe"); dst = "WinBridgeAgentDaemon.exe" },
          @{ src = (Join-Path $buildDir "updater\\$config\\Updater.exe"); dst = "Updater.exe" }
        )

        foreach ($i in $items) {
          if (Test-Path $i.src) {
            Copy-Item -Force $i.src (Join-Path $distDir $i.dst)
            Write-Host "Copied: $($i.src) -> $($i.dst)"
          } else {
            Write-Host "Missing: $($i.src)"
          }
        }

        $zipName = "WinBridgeAgent-${{ github.ref_name }}-windows-${config}.zip"
        if ("${{ github.ref_name }}" -eq "" -or "${{ github.ref_name }}" -eq "main") {
          $zipName = "WinBridgeAgent-windows-${config}.zip"
        }

        $zipPath = Join-Path $buildDir $zipName
        if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
        Compress-Archive -Path (Join-Path $distDir "*") -DestinationPath $zipPath

        # Prefer a workspace-relative path for downstream actions.
        $zipRel = "build/$zipName"
        "zip_path=$zipRel" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: WinBridgeAgent-windows-${{ matrix.build_type }}
        path: ${{ steps.package.outputs.zip_path }}

    # Tests are currently flaky / environment-dependent on GitHub-hosted runners.
    # Keep local test builds available, but skip in CI for now.
