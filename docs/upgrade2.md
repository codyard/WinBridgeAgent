WinAgent 项目质量与工程化改进计划 (v1.0)


  文档目的: 本文档旨在为 WinAgent
  项目制定一个系统性的改进路线图，以提升其代码质量、稳定性、可维护
  性和开发效率，使其达到专业级、可长期演进的商业项目标准。

  作者: 资深C++开发者 (AI)

  日期: 2026年02月09日

  ---

  1. 核心目标与指导原则


  我们的核心目标不是简单地增加功能，而是构建一个健壮的工程体系。


   * 核心目标:
       1. 提升稳定性: 大幅降低运行时崩溃和资源泄漏的风险。
       2. 提高可维护性: 使代码更易于理解、修改和重构。
       3. 加速开发迭代: 让新功能的开发和 bug 修复更安全、更快速。


   * 指导原则:
       1. 测试驱动 (Test-Driven): 测试不是辅助，而是开发的基石。
       2. 自动化优先 (Automation-First):
          凡是能自动化的，绝不手动操作。
       3. 拥抱现代 C++ (Embrace Modern C++): 全面采用 C++17/20
          的最佳实践。
       4. 持续集成/持续交付 (CI/CD): 质量门禁是不可逾越的红线。


  ---

  2. 改进路线图 (Improvement Roadmap)

  我将此计划分为三个循序渐进的阶段。每个阶段都有明确的交付成果，并
  为下一阶段奠定基础。


  ##### 阶段一: 奠定基础 - 质量门禁与自动化 (预计用时: 1-2周)

  目标: 在不大规模改动业务代码的情况下，建立起自动化的质量保障体系
  。这是投入产出比最高的一个阶段。


   * 任务 1.1: 统一代码风格
       * 步骤:
           1. 在项目根目录创建 .clang-format 配置文件。
           2. 选择一个基础风格（建议 Google 或
              LLVM），并根据团队习惯微调。
           3. 编写一个 scripts/format.sh 脚本，用于一键格式化所有 src
              和 include 目录下的代码。
       * 产出: 全项目代码风格统一，提高代码可读性。


   * 任务 1.2: 引入静态代码分析
       * 步骤:
           1. 在项目根目录创建 .clang-tidy 配置文件。
           2. 启用一系列检查项，初期可以从 modernize-*, performance-*,
              bugprone-* 开始。
           3. 修改 CMakeLists.txt，集成
              clang-tidy，使其可以在编译时运行。
       * 产出: 发现并修复一批潜在的 bug 和不规范写法。


   * 任务 1.3: 强化 CI 流水线
       * 步骤:
           1. 修改 .github/workflows/release.yml（或创建一个新的
              ci.yml）。
           2. 在流水线中增加两个步骤：
               * 代码风格检查: 运行 clang-format --dry-run 
                 -Werror，确保所有提交的代码都已格式化。
               * 静态分析检查: 运行 clang-tidy，将警告视为错误。
           3. 配置分支保护规则，要求所有 Pull Request 必须通过 CI
              检查才能合并。
       * 产出:
         建立起自动化的质量“门禁”，不符合规范的代码无法进入主分支。


   * 任务 1.4: 清理项目结构
       * 步骤:
           1. 创建一个 docs/project_logs 或类似目录。
           2. 将根目录下所有非标准的 .md 文件（如 BUGFIX_*.md,
              RELEASE_SUMMARY_*.md 等）移动到该目录下。
       * 产出: 一个整洁、专业的项目根目录。

  ##### 阶段二: 核心重构 - 测试与健壮性 (预计用时: 4-6周)


  目标: 解决项目最大的短板——测试。通过引入单元测试和集成测试，为未
  来的重构和功能开发提供安全网。


   * 任务 2.1: 引入测试框架
       * 步骤:
           1. 选择 GoogleTest 作为测试框架。
           2. 修改 CMakeLists.txt，在 tests 目录下创建一个名为
              winagent_tests 的测试可执行文件，并链接 GoogleTest。
       * 产出: 项目具备了运行单元测试和集成测试的能力。


   * 任务 2.2: 编写首个单元测试
       * 步骤:
           1. 选择一个相对独立、逻辑清晰的模块作为起点，例如
              support/config_manager.cpp。
           2. 在 tests/unit/ 目录下，创建 test_config_manager.cpp。
           3. 编写测试用例，覆盖其加载、解析、获取配置项等核心功能。
       * 产出: 第一个单元测试，为团队建立测试样板。


   * 任务 2.3: 重构以支持可测试性 (依赖注入)
       * 步骤:
           1. 识别服务间的依赖关系（例如 HttpRoutes 依赖多个
              Service）。
           2. 修改构造函数，将依赖作为接口（抽象基类）指针或智能指针传
              入，而不是在构造函数内部 new。
           3. 示例: HttpRoutes 的构造函数应为
              HttpRoutes(std::shared_ptr<ScreenshotService> 
              screenshotSvc, ...) 而不是 HttpRoutes() { m_screenshotSvc
               = std::make_shared<ScreenshotService>(); }。

       * 产出: 核心代码解耦，为 Mock 测试铺平道路。


   * 任务 2.4: 编写首个集成测试
       * 步骤:
           1. 在 tests/integration/ 目录下，创建 test_http_api.cpp。
           2. 在测试代码中，启动一个配置了所有服务的 HttpServer 实例。
           3. 使用 cpp-httplib 的客户端功能，向本地服务器发送 HTTP
              请求（例如 GET /api/v1/status）。
           4. 断言返回的 HTTP 状态码和 JSON 响应内容符合预期。
       * 产出: 第一个 API 集成测试，验证端到端的逻辑。


   * 任务 2.5: 将测试集成到 CI
       * 步骤:
           1. 在 CI 脚本中，编译 winagent_tests。
           2. 执行该测试文件，并确保其返回码为 0。
       * 产出: CI 流水线现在包含编译、静态分析、代码风格检查和自动化
         测试，形成一个完整的质量闭环。

  ##### 阶段三: 现代化与长期维护 (持续进行)


  目标: 全面拥抱现代 C++
  实践，并引入更高级的工程工具，确保项目长期健康发展。


   * 任务 3.1: 全面转向 Modern CMake
       * 步骤:
           1. 系统性地审查所有 CMakeLists.txt 文件。
           2. 用 target_* 命令替代所有旧的全局命令。
           3. 将项目划分为更细粒度的 CMake Target，明确它们之间的
              PRIVATE/PUBLIC/INTERFACE 依赖关系。
       * 产出: 一个模块化、易于推理和维护的构建系统。


   * 任务 3.2: 引入依赖管理器
       * 步骤:
           1. 选择 vcpkg，并采用其 manifest (清单) 模式。
           2. 在根目录创建 vcpkg.json 文件，声明对 nlohmann-json,
              cpp-httplib 等库的依赖。
           3. 从 third_party 目录中移除这些库的源代码，并修改 CMake
              以通过 vcpkg 查找它们。
       * 产出:
         声明式的、可复现的依赖管理，极大简化依赖升级和新依赖的引入。


   * 任务 3.3: 代码库现代化审查
       * 步骤:
           1. 发起一个专项代码审查活动。
           2. 重点关注：裸指针/裸 new/delete
              的消除（替换为智能指针）、RAII 的应用、const
              正确性、错误处理策略的统一（推广使用 std::optional 或
              std::expected）。
       * 产出: 更安全、更现代、更易读的代码库。


   * 任务 3.4: 自动化文档
       * 步骤:
           1. 引入 Doxygen。
           2. 规范头文件中的注释风格（例如 Javadoc 风格）。
           3. 配置 Doxygen，使其能从代码注释自动生成 HTML 格式的 API
              文档。
       * 产出: 与代码永远同步的 API 文档，降低维护成本。

  ---

  3. 预期成果

  完成以上计划后，WinAgent 项目将达成以下成果：


   * 质量: Bug 数量显著减少，线上稳定性大幅提升。
   * 效率:
     开发者可以放心地进行重构，新功能交付速度更快，新成员上手更容易。
   * 文化: 团队将建立起以质量和自动化为核心的现代软件工程文化。
   * 价值: 项目的技术债务得到有效控制，能够支撑未来更复杂的需求和更长
     的生命周期。